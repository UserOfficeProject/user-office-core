# name: build
# on: [push, workflow_dispatch]

# permissions:
#   actions: write   # needed for listing runners

# jobs:
#   choose-runner:
#     runs-on: ubuntu-latest
#     outputs:
#       runs_on: ${{ steps.pick.outputs.runs_on }}
#     steps:
#       - id: pick
#         uses: actions/github-script@v7
#         with:
#           script: |
#             const useSelfHosted = Math.random() < 0.5
#             core.setOutput('runs_on', useSelfHosted
#               ? '["self-hosted","Linux","X64"]'
#               : '"ubuntu-latest"'
#             )

#   build:
#     needs: choose-runner
#     runs-on: ${{ fromJSON(needs.choose-runner.outputs.runs_on) }}
#     steps:
#       - id: fake-build
#         run: |
#           echo "Using runner labels: ${{ needs.choose-runner.outputs.runs_on }}"
#           echo "Runner name: $(hostname)"
#           sleep 3
#           echo "Build complete"

name: build
on: [push, workflow_dispatch]

permissions:
  actions: read

jobs:
  choose:
    runs-on: ubuntu-latest
    outputs:
      matrix: ${{ steps.make.outputs.matrix }}
    steps:
      - name: Get idle runner count (repo-level)
        id: get
        env:
          OWNER: ${{ github.repository_owner }}
          AUTH: ${{ secrets.GH_API_TOKEN != '' && secrets.GH_API_TOKEN || github.token }}
        run: |
          set -euo pipefail
          REPO="${GITHUB_REPOSITORY#*/}"

          RESPONSE="$(
            curl -sS --fail \
              -H "Authorization: Bearer $AUTH" \
              -H "Accept: application/vnd.github+json" \
              -H "X-GitHub-Api-Version: 2022-11-28" \
              "https://api.github.com/repos/$OWNER/$REPO/actions/runners?per_page=100"
          )"

          IDLE="$(echo "$RESPONSE" | jq '[(.runners // [])[] | select(.busy == false)] | length')"
          echo "idle=$IDLE" >> "$GITHUB_OUTPUT"

      - name: Build 5-slot matrix (self-hosted first, then ubuntu)
        id: make
        run: |
          set -euo pipefail
          # Clamp to [0..5]
          N="${{ steps.get.outputs.idle }}"
          if [ "$N" -gt 5 ]; then N=5; fi
          if [ "$N" -lt 0 ]; then N=0; fi

          MATRIX="$(jq -n --argjson n "$N" '
            [ range(0;5) | {
                slot: (.+1),
                # runs_on is either an array (labels) or a string; weâ€™ll fromJSON() it later
                runs_on: (if . < $n then ["self-hosted","Linux","X64"] else "ubuntu-latest" end)
              } ]
          ')"

          echo "matrix=$MATRIX" >> "$GITHUB_OUTPUT"
          echo "Matrix: $MATRIX"

  build:
    needs: choose
    strategy:
      # [{slot:1,runs_on:[...]}, {slot:2,runs_on:"ubuntu-latest"}, ...]
      matrix: ${{ fromJSON(needs.choose.outputs.matrix) }}
    # Use whatever came in each matrix entry
    runs-on: ${{ fromJSON(toJson(matrix.runs_on)) }}
    steps:
      - run: |
          echo "Slot: ${{ matrix.slot }}"
          echo "runs-on: ${{ toJson(matrix.runs_on) }}"
          echo "Host: $(hostname)"




