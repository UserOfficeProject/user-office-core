# name: build
# on: [push, workflow_dispatch]

# permissions:
#   actions: write   # needed for listing runners

# jobs:
#   choose-runner:
#     runs-on: ubuntu-latest
#     outputs:
#       runs_on: ${{ steps.pick.outputs.runs_on }}
#     steps:
#       - id: pick
#         uses: actions/github-script@v7
#         with:
#           script: |
#             const useSelfHosted = Math.random() < 0.5
#             core.setOutput('runs_on', useSelfHosted
#               ? '["self-hosted","Linux","X64"]'
#               : '"ubuntu-latest"'
#             )

#   build:
#     needs: choose-runner
#     runs-on: ${{ fromJSON(needs.choose-runner.outputs.runs_on) }}
#     steps:
#       - id: fake-build
#         run: |
#           echo "Using runner labels: ${{ needs.choose-runner.outputs.runs_on }}"
#           echo "Runner name: $(hostname)"
#           sleep 3
#           echo "Build complete"

name: build
on: [push, workflow_dispatch]

jobs:
  choose:
    runs-on: ubuntu-latest
    outputs:
      matrix: ${{ steps.make.outputs.matrix }}
    steps:
      - name: Get idle runner count (repo-level)
        env:
          OWNER: ${{ github.repository_owner }}
          AUTH: ${{ secrets.GH_API_TOKEN != '' && secrets.GH_API_TOKEN || github.token }}
        run: |
          set -euo pipefail
          REPO="${GITHUB_REPOSITORY#*/}"

          RESPONSE="$(
            curl -sS --fail \
              -H "Authorization: Bearer $AUTH" \
              "https://api.github.com/repos/$OWNER/$REPO/actions/runners?per_page=100"
          )"

          IDLE="$(echo "$RESPONSE" | jq '[(.runners // [])[] | select(.busy == false)] | length')"
          echo "idle=$IDLE" >> "$GITHUB_OUTPUT"

      - name: Build runner matrix
        id: make
        run: |
          set -euo pipefail
          NUM_RUNNERS="${{ steps.get.outputs.idle }}"

          MATRIX="$(jq -nc --argjson n "$NUM_RUNNERS" '
            [ range(0;5) |(if . < $n then "self" else "github" end)]
          ')"

          echo "matrix=$MATRIX" >> "$GITHUB_OUTPUT"
          echo "Matrix: $MATRIX"

  build:
    needs: choose
    strategy:
      matrix:
        runner: ${{ fromJSON(needs.choose.outputs.matrix) }}
    runs-on: ${{ fromJSON( matrix.runner == 'self'
                           && '["self-hosted","Linux","X64"]'
                           || '"ubuntu-latest"' ) }}
    steps:
      - run: |
          echo "Runner key: ${{ matrix.runner }}"
          echo "Hostname: $(hostname)"




