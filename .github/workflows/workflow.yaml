# name: build
# on: [push, workflow_dispatch]

# permissions:
#   actions: write   # needed for listing runners

# jobs:
#   choose-runner:
#     runs-on: ubuntu-latest
#     outputs:
#       runs_on: ${{ steps.pick.outputs.runs_on }}
#     steps:
#       - id: pick
#         uses: actions/github-script@v7
#         with:
#           script: |
#             const useSelfHosted = Math.random() < 0.5
#             core.setOutput('runs_on', useSelfHosted
#               ? '["self-hosted","Linux","X64"]'
#               : '"ubuntu-latest"'
#             )

#   build:
#     needs: choose-runner
#     runs-on: ${{ fromJSON(needs.choose-runner.outputs.runs_on) }}
#     steps:
#       - id: fake-build
#         run: |
#           echo "Using runner labels: ${{ needs.choose-runner.outputs.runs_on }}"
#           echo "Runner name: $(hostname)"
#           sleep 3
#           echo "Build complete"

name: list-runners
on: [push, workflow_dispatch]

permissions:
  actions: read

jobs:
  list:
    runs-on: ubuntu-latest
    steps:
      - name: List repo runners via curl
        env:
          OWNER: ${{ github.repository_owner }}
          # Use GITHUB_TOKEN (works for repo-level runners) or your PAT in GH_API_TOKEN
          AUTH: ${{ secrets.GH_API_TOKEN != '' && secrets.GH_API_TOKEN || github.token }}
        run: |
          set -euo pipefail
          REPO="${GITHUB_REPOSITORY#*/}"

          RESPONSE="$(
            curl -sS --fail \
              -H "Authorization: Bearer $AUTH" \
              -H "Accept: application/vnd.github+json" \
              -H "X-GitHub-Api-Version: 2022-11-28" \
              "https://api.github.com/repos/$OWNER/$REPO/actions/runners?per_page=100"
          )"

          IDLE_SELF_RUNNERS="${echo "$json" | jq '[(.runners // [])[] | select(.busy == false)] | length'}"

          echo $IDLE_SELF_RUNNERS



