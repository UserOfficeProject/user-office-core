version: '3.1'

services:
  # used to proxy the core UI FE and BE requests to the right container
  # Core FE is accessible on localhost:33000/
  # Core BE is accessible on localhost:33000/graphql
  proxy:
    image: traefik:2.10 # The official Traefik docker image
    command:
      #- "--log.level=DEBUG"
      - '--api.insecure=true'
      - '--providers.docker=true'
      - '--providers.docker.exposedbydefault=false'
      - '--entrypoints.web.address=:80'
    ports:
      - '80:80' # The HTTP port
      - '8080:8080' # The Web UI (enabled by --api)
    volumes:
      - /var/run/docker.sock:/var/run/docker.sock:ro
    labels:
      - 'traefik.enable=true'
      - 'traefik.http.routers.traefik.rule=Host(`pms-dev.stfc.ac.uk`)'
      - 'traefik.http.routers.traefik.entrypoints=web'
      - 'traefik.http.routers.traefik.service=api@internal'
  db:
    image: postgres:16-alpine
    restart: always
    environment:
      POSTGRES_PASSWORD: duopassword
      POSTGRES_USER: duouser
      POSTGRES_DB: duo
    ports:
      - '5432:5432'
    volumes:
      - ./apps/backend/db_patches/:/docker-entrypoint-initdb.d/

  factory:
    image: 'ghcr.io/userofficeproject/user-office-factory:develop'
    init: true
    environment:
      - NODE_ENV=development
      - DATABASE_HOSTNAME=db
      - DATABASE_PORT=5432
      - DATABASE_USER=duouser
      - DATABASE_PASSWORD=duopassword
      - DATABASE_DATABASE=duo
    cap_add:
      - SYS_ADMIN
    depends_on:
      - db

  frontend:
    image: 'ghcr.io/userofficeproject/user-office-frontend:develop'
    labels:
      - 'traefik.enable=true'
      - 'traefik.http.services.frontend.loadbalancer.server.port=8080'
      - 'traefik.http.routers.frontend.rule=(Host(`pms-dev.stfc.ac.uk`) && PathPrefix(`/`))'
    depends_on:
      - backend

  backend:
    image: 'ghcr.io/userofficeproject/user-office-backend:develop'
    environment:
      DATABASE_URL: postgres://duouser:duopassword@db:5432/duo
      JWT_SECRET: qMyLZALzs229ybdQXNyzYRdju7X784TH
      JWT_TOKEN_LIFE: 7d
      BASE_URL: http://pms-dev.stfc.ac.uk
      NODE_ENV: development
      USER_OFFICE_FACTORY_ENDPOINT: http://factory:4500/generate
      AUTH_DISCOVERY_URL: http://pms-dev.stfc.ac.uk:5001/.well-known/openid-configuration
      AUTH_CLIENT_ID: useroffice
      AUTH_CLIENT_SECRET: useroffice
      TZ: Europe/Stockholm
      DATE_FORMAT: dd-MM-yyyy
      DATE_TIME_FORMAT: dd-MM-yyyy HH:mm
      # INITIAL_USER_OFFICER_EMAIL: 
    labels:
      - 'traefik.enable=true'
      - 'traefik.http.services.backend.loadbalancer.server.port=4000'
      - 'traefik.http.routers.backend.rule=Host(`pms-dev.stfc.ac.uk`)'
      - 'traefik.http.routers.backend.rule=(PathPrefix(`/api`) || PathPrefix(`/preview`) || PathPrefix(`/downloads`) || PathPrefix(`/files`) || PathPrefix(`/download`) || PathPrefix(`/uploads`) || PathPrefix(`/graphql`))'
    ports:
      - "4000:4000"
    depends_on:
      - duo-development-authorization-server
      - db
    extra_hosts:
      - 'host.docker.internal:host-gateway'

  duo-development-authorization-server:
    build:
      context: ../user-office-development-authorization-server
    ports:
      - 5001:5001
    environment:
      ISSUER: http://pms-dev.stfc.ac.uk
      DATABASE_URL: postgres://duouser:duopassword@db:5432/duo
      PORT: 5001
    labels:
      - 'traefik.enable=true'
      - 'traefik.http.services.authserver.loadbalancer.server.port=5001'
      - 'traefik.http.routers.authserver.rule=Host(`pms-dev.stfc.ac.uk`)'
      - 'traefik.http.routers.authserver.rule=(PathPrefix(`/interaction`) || PathPrefix(`/session`) || PathPrefix(`/auth`))'
    depends_on:
      - db
